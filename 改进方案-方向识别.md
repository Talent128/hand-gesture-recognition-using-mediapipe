# 动态手势方向识别改进方案

## 📋 改进目标

将原有的"Move（移动）"类别细化为4个方向：
- Move Up（向上）
- Move Down（向下）
- Move Left（向左）
- Move Right（向右）

---

## 🔧 实施步骤

### 步骤1：修改标签文件

**文件**: `model/point_history_classifier/point_history_classifier_label.csv`

**修改前**:
```csv
Stop
Clockwise
Counter Clockwise
Move
```

**修改后**:
```csv
Stop
Clockwise
Counter Clockwise
Move Up
Move Down
Move Left
Move Right
```

**操作**:
```bash
# 直接编辑文件，或使用命令
cat > model/point_history_classifier/point_history_classifier_label.csv << EOF
Stop
Clockwise
Counter Clockwise
Move Up
Move Down
Move Left
Move Right
EOF
```

---

### 步骤2：修改训练配置

**文件**: `point_history_classification.ipynb`

找到以下代码：

```python
# 分类数设置
NUM_CLASSES = 4
```

**修改为**:
```python
# 分类数设置
NUM_CLASSES = 7  # 0:Stop, 1:Clockwise, 2:Counter Clockwise, 3:Up, 4:Down, 5:Left, 6:Right
```

---

### 步骤3：采集训练数据

#### 3.1 清理或备份旧数据（可选）

```bash
# 备份现有数据
cp model/point_history_classifier/point_history.csv model/point_history_classifier/point_history_backup.csv

# 如果要全部重新采集，可以清空文件（保留表头）
# 或者直接在现有数据上追加新类别数据
```

#### 3.2 数据采集策略

使用 `app.py` 进行数据采集，每个类别建议采集：

| 类别编号 | 手势名称 | 建议样本数 | 采集要点 |
|---------|---------|-----------|---------|
| 0 | Stop | 300-500 | 保持手不动，采集静止状态 |
| 1 | Clockwise | 400-600 | 顺时针画圆，速度适中 |
| 2 | Counter Clockwise | 400-600 | 逆时针画圆，速度适中 |
| 3 | Move Up | 400-600 | **向上直线移动，保持垂直** |
| 4 | Move Down | 400-600 | **向下直线移动，保持垂直** |
| 5 | Move Left | 400-600 | **向左直线移动，保持水平** |
| 6 | Move Right | 400-600 | **向右直线移动，保持水平** |

**总计**: 2700-4200 个样本

#### 3.3 具体采集步骤

**1. 启动数据采集模式**:
```bash
python app.py
```

**2. 进入轨迹采集模式**:
- 按 `h` 键进入轨迹采集模式
- 屏幕会显示 "MODE: Logging Point History"

**3. 采集各类别数据**:

##### 类别 0: Stop（停止）
```
按 '0' → 做出"Pointer"手势但保持不动 → 采集 300-500 次
```

##### 类别 1: Clockwise（顺时针）
```
按 '1' → 做出"Pointer"手势 → 顺时针画圆 → 采集 400-600 次
```

##### 类别 2: Counter Clockwise（逆时针）
```
按 '2' → 做出"Pointer"手势 → 逆时针画圆 → 采集 400-600 次
```

##### 类别 3: Move Up（向上）⬆️
```
按 '3' → 做出"Pointer"手势 → 从下向上直线移动 → 采集 400-600 次

采集技巧：
✓ 起点在屏幕下方，终点在上方
✓ 尽量保持垂直移动
✓ 速度适中（不要太快或太慢）
✓ 移动距离适中（约占屏幕高度的1/3-1/2）
✓ 从不同起点位置采集（左中右）
```

##### 类别 4: Move Down（向下）⬇️
```
按 '4' → 做出"Pointer"手势 → 从上向下直线移动 → 采集 400-600 次

采集技巧：
✓ 起点在屏幕上方，终点在下方
✓ 尽量保持垂直移动
✓ 速度和距离与"向上"保持一致
✓ 从不同起点位置采集
```

##### 类别 5: Move Left（向左）⬅️
```
按 '5' → 做出"Pointer"手势 → 从右向左直线移动 → 采集 400-600 次

采集技巧：
✓ 起点在屏幕右侧，终点在左侧
✓ 尽量保持水平移动
✓ 速度适中
✓ 移动距离约占屏幕宽度的1/3-1/2
✓ 从不同高度位置采集（上中下）
```

##### 类别 6: Move Right（向右）➡️
```
按 '6' → 做出"Pointer"手势 → 从左向右直线移动 → 采集 400-600 次

采集技巧：
✓ 起点在屏幕左侧，终点在右侧
✓ 尽量保持水平移动
✓ 速度和距离与"向左"保持一致
✓ 从不同高度位置采集
```

**4. 采集过程中的注意事项**:

```
✅ DO（推荐做法）：
- 保持手势稳定，动作流畅
- 每次采集完成后稍作停顿
- 从不同角度、不同位置采集
- 在不同光照条件下采集
- 速度变化：慢速、中速、快速
- 幅度变化：小幅、中幅、大幅

❌ DON'T（避免）：
- 移动太快或太慢
- 动作不规范（如向上移动时偏斜）
- 手超出摄像头视野
- 背景过于复杂
- 光线过暗或过亮
```

**5. 查看采集进度**:

```python
# 可以随时检查采集的数据量
import pandas as pd

df = pd.read_csv('model/point_history_classifier/point_history.csv', header=None)
print("各类别样本数量：")
print(df[0].value_counts().sort_index())
```

输出示例：
```
各类别样本数量：
0     450  # Stop
1     550  # Clockwise
2     530  # Counter Clockwise
3     500  # Move Up
4     480  # Move Down
5     510  # Move Left
6     495  # Move Right
dtype: int64
```

---

### 步骤4：训练新模型

#### 4.1 打开训练脚本

```bash
# 使用 Jupyter Notebook
jupyter notebook point_history_classification.ipynb

# 或使用 VSCode 打开 .ipynb 文件
```

#### 4.2 检查配置

确认以下设置正确：

```python
# Cell 1: 导入库
import csv
import numpy as np
import tensorflow as tf
from sklearn.model_selection import train_test_split

RANDOM_SEED = 42

# Cell 2: 路径设置
dataset = 'model/point_history_classifier/point_history.csv'
model_save_path = 'model/point_history_classifier/point_history_classifier.hdf5'

# Cell 3: 分类数设置（重要！）
NUM_CLASSES = 7  # ← 确保改为 7

# Cell 4: 输入长度
TIME_STEPS = 16
DIMENSION = 2
```

#### 4.3 执行训练

按顺序执行所有单元格：

1. ✅ 导入库和设置
2. ✅ 加载数据
3. ✅ 划分训练集和测试集
4. ✅ 构建模型
5. ✅ 查看模型结构
6. ✅ 配置回调函数
7. ✅ 编译模型
8. ✅ 训练模型（这一步耗时较长）
9. ✅ 评估模型
10. ✅ 查看混淆矩阵
11. ✅ 转换为 TFLite 格式

#### 4.4 模型结构调整建议

由于类别数从4增加到7，建议增加模型容量：

**原始结构**:
```python
model = tf.keras.models.Sequential([
    tf.keras.layers.InputLayer(input_shape=(TIME_STEPS * DIMENSION, )),
    tf.keras.layers.Dropout(0.2),
    tf.keras.layers.Dense(24, activation='relu'),
    tf.keras.layers.Dropout(0.5),
    tf.keras.layers.Dense(10, activation='relu'),
    tf.keras.layers.Dense(NUM_CLASSES, activation='softmax')
])
```

**建议改进**（可选）:
```python
model = tf.keras.models.Sequential([
    tf.keras.layers.InputLayer(input_shape=(TIME_STEPS * DIMENSION, )),
    tf.keras.layers.Dropout(0.2),
    tf.keras.layers.Dense(32, activation='relu'),      # 24 → 32
    tf.keras.layers.Dropout(0.4),                       # 0.5 → 0.4
    tf.keras.layers.Dense(16, activation='relu'),      # 10 → 16
    tf.keras.layers.Dropout(0.3),                       # 新增
    tf.keras.layers.Dense(NUM_CLASSES, activation='softmax')
])
```

#### 4.5 训练监控

训练过程中关注以下指标：

```
Epoch 1/1000
loss: 1.9456 - accuracy: 0.2345 - val_loss: 1.8234 - val_accuracy: 0.2567

目标指标：
- val_accuracy > 0.90 (90%以上)
- val_loss 稳定下降
- 训练集和验证集准确率差距 < 5%（避免过拟合）
```

#### 4.6 查看混淆矩阵

训练完成后，混淆矩阵应该显示：
- 对角线值较高（正确分类）
- 非对角线值较低（错误分类）

**重点关注**：
- Move Up 和 Move Down 是否容易混淆
- Move Left 和 Move Right 是否容易混淆
- Stop 是否被误判为其他类别

如果某两个类别经常混淆，需要：
1. 增加这两个类别的训练数据
2. 采集时动作更规范
3. 调整模型结构

---

### 步骤5：测试新模型

#### 5.1 运行实时识别

```bash
python app.py
```

#### 5.2 测试各个方向

做出"Pointer"手势，然后：
- ⬆️ 向上移动 → 应显示 "Move Up"
- ⬇️ 向下移动 → 应显示 "Move Down"
- ⬅️ 向左移动 → 应显示 "Move Left"
- ➡️ 向右移动 → 应显示 "Move Right"

#### 5.3 测试场景

| 场景 | 期望结果 |
|------|---------|
| 快速向上划 | Move Up |
| 慢速向上划 | Move Up |
| 斜向上划（稍微偏斜） | Move Up |
| 左上角向右下角 | 可能混淆，需关注 |
| 停在原地不动 | Stop |
| 画圆圈 | Clockwise / Counter Clockwise |

---

## 📊 数据采集详细指南

### 采集环境要求

```
✓ 光线充足（自然光或白光）
✓ 背景简洁（纯色墙壁最佳）
✓ 摄像头固定稳定
✓ 距离摄像头 30-50cm
✓ 手完全在画面内
```

### 采集多样性

为了提高模型泛化能力，建议从多个维度采集数据：

#### 1. 速度多样性
```
每个方向采集 3 种速度：
- 慢速：2-3秒完成移动 (150-200个样本)
- 中速：1-1.5秒完成移动 (150-200个样本)
- 快速：0.5-1秒完成移动 (100-150个样本)
```

#### 2. 幅度多样性
```
每个方向采集 3 种幅度：
- 小幅：移动距离约屏幕的1/4 (100-150个样本)
- 中幅：移动距离约屏幕的1/3 (200-250个样本)
- 大幅：移动距离约屏幕的1/2 (100-150个样本)
```

#### 3. 位置多样性
```
向上/向下：从屏幕左、中、右三个位置起始
向左/向右：从屏幕上、中、下三个位置起始
```

#### 4. 手部姿态多样性
```
- 食指完全伸直
- 食指稍微弯曲
- 手掌角度稍有变化
```

### 采集脚本（自动化辅助）

可以创建一个辅助脚本来提醒采集进度：

```python
# collection_helper.py
import pandas as pd
import os

def check_collection_progress():
    csv_path = 'model/point_history_classifier/point_history.csv'
    
    if not os.path.exists(csv_path):
        print("数据文件不存在！")
        return
    
    df = pd.read_csv(csv_path, header=None)
    counts = df[0].value_counts().sort_index()
    
    labels = ['Stop', 'Clockwise', 'Counter Clockwise', 
              'Move Up', 'Move Down', 'Move Left', 'Move Right']
    
    targets = [400, 500, 500, 500, 500, 500, 500]  # 目标样本数
    
    print("\n" + "="*60)
    print("数据采集进度报告")
    print("="*60)
    
    total_collected = 0
    total_target = sum(targets)
    
    for i in range(7):
        current = counts.get(i, 0)
        target = targets[i]
        progress = (current / target) * 100 if target > 0 else 0
        status = "✅" if progress >= 100 else "🔄"
        
        print(f"{status} 类别 {i} ({labels[i]:20s}): {current:4d}/{target:4d} ({progress:5.1f}%)")
        print("   " + "█" * int(progress / 5) + "░" * (20 - int(progress / 5)))
        
        total_collected += current
    
    overall_progress = (total_collected / total_target) * 100
    print("="*60)
    print(f"总体进度: {total_collected}/{total_target} ({overall_progress:.1f}%)")
    print("="*60)
    
    if overall_progress >= 100:
        print("\n🎉 恭喜！数据采集完成，可以开始训练了！")
    else:
        remaining = total_target - total_collected
        print(f"\n还需采集 {remaining} 个样本")

if __name__ == '__main__':
    check_collection_progress()
```

使用方法：
```bash
python collection_helper.py
```

---

## 🎯 预期效果

训练完成后，系统应该能够：

| 手势动作 | 识别结果 | 准确率目标 |
|---------|---------|-----------|
| 垂直向上移动 | Move Up | >90% |
| 垂直向下移动 | Move Down | >90% |
| 水平向左移动 | Move Left | >90% |
| 水平向右移动 | Move Right | >90% |
| 顺时针画圆 | Clockwise | >90% |
| 逆时针画圆 | Counter Clockwise | >90% |
| 保持不动 | Stop | >95% |

---

## ⚠️ 常见问题及解决

### 问题1：上下方向经常混淆

**原因**: 采集数据时角度不够垂直

**解决方案**:
```
1. 重新采集数据，强调垂直移动
2. 增加这两个类别的样本数到 700-800
3. 在采集时使用参考线（如屏幕边缘）
```

### 问题2：左右方向经常混淆

**原因**: 采集数据时角度不够水平

**解决方案**:
```
1. 重新采集数据，强调水平移动
2. 增加样本多样性（不同高度位置）
3. 确保移动距离足够（至少屏幕宽度的1/3）
```

### 问题3：方向识别延迟

**原因**: 模型等待16帧历史数据

**解决方案**:
```
1. 保持当前设置（16帧是合理的）
2. 或减少到12帧（修改 TIME_STEPS = 12）
3. 需要重新采集和训练
```

### 问题4：斜向移动被误识别

**原因**: 训练数据中只有垂直和水平移动

**解决方案**:
```
选项1: 接受现状，模型会将斜向移动识别为最接近的方向
选项2: 增加4个斜向类别（左上、右上、左下、右下）
       这会使类别数达到11类，需要更多数据
```

### 问题5：模型准确率低于80%

**原因**: 数据质量或数量不足

**解决方案**:
```
1. 检查数据分布是否均衡
2. 增加每个类别的样本数到 800-1000
3. 改善采集环境（光线、背景）
4. 增加模型容量（更多神经元）
5. 使用 LSTM 模型（use_lstm = True）
```

---

## 📈 进阶优化

### 优化1：数据增强

```python
# 在训练时添加数据增强
import numpy as np

def augment_trajectory(trajectory):
    """
    对轨迹数据进行增强
    """
    # 添加小量噪声
    noise = np.random.normal(0, 0.01, trajectory.shape)
    augmented = trajectory + noise
    
    # 随机缩放
    scale = np.random.uniform(0.9, 1.1)
    augmented = augmented * scale
    
    return augmented

# 在训练前应用
X_train_augmented = np.array([augment_trajectory(x) for x in X_train])
```

### 优化2：使用LSTM模型

```python
# 在 point_history_classification.ipynb 中设置
use_lstm = True  # 改为 True

# LSTM 更适合时序数据，可能提高准确率 2-5%
```

### 优化3：后处理平滑

```python
# 在 app.py 中添加时序平滑
from collections import Counter, deque

# 使用投票机制
direction_history = deque(maxlen=5)  # 保存最近5次预测
direction_history.append(current_direction)

# 取最常见的方向
most_common_direction = Counter(direction_history).most_common(1)[0][0]
```

---

## 📝 总结

完成以上步骤后，您的手势识别系统将具备：

✅ 7种动态手势识别能力
✅ 精确的方向识别（上下左右）
✅ 更丰富的交互可能性

**时间估算**:
- 数据采集：2-3小时
- 模型训练：10-30分钟
- 测试调优：30分钟-1小时
- **总计**：3-5小时

**数据量估算**:
- 最少：2800个样本（每类400个）
- 推荐：3500个样本（每类500个）
- 最佳：5600个样本（每类800个）

祝您改进顺利！🚀

